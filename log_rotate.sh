# Использовался для ротации бэкапов на esrn-cloud-02 в МетаПрайм

#!/bin/bash

# Директория, в которой хранятся бэкапы
BACKUP_DIR="/srv/sitex/backups"

# Ищем все архивы формата *_YYYYMMDD.tar.gz
# Извлекаем уникальные префиксы (части имени файла до даты)
prefixes=$(find "$BACKUP_DIR" -maxdepth 1 -type f -regextype posix-extended \
    -regex '.*/[^/]+_[0-9]{8}\.tar\.gz' \
    | sed -E 's|.*/([^/]+)_[0-9]{8}\.tar\.gz|\1|' \
    | sort -u)

# Обрабатываем каждый уникальный префикс по отдельности
for prefix in $prefixes; do
    echo "Обработка бэкапов: $prefix"

    # Находим все файлы соответствующие шаблону <prefix>_YYYYMMDD.tar.gz
    # Выводим время модификации (%T@) и имя файла, сортируем по убыванию времени
    # Пропускаем первые 7 файлов (самые новые), начиная с 8-го и далее — это кандидаты на удаление
    # cut удаляет колонку с датой, оставляя только путь к файлу
    find "$BACKUP_DIR" -maxdepth 1 -type f -name "${prefix}_[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9].tar.gz" \
        -printf "%T@ %p\n" | sort -nr | tail -n +8 | cut -d' ' -f2- \
        | while read file; do
            # Удаляем файл, т.к. он старее первых 7 последних
            echo "Удаляется: $file"
            rm -v "$file"
        done

done